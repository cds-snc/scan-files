name: "DAST vulnerability scan"

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Build, Push and Deploy to Staging"
      - "Deploy Lambda Docker images to production"   
    types:
      - completed

jobs:
  dast-vulnerability-scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - url: 'https://scan-files.alpha.canada.ca/docs'
          - url: 'https://scan-files.cdssandbox.xyz/docs'
    
    steps:
      - name: Run Dastardly
        uses: PortSwigger/dastardly-github-action@main
        with:
          target-url: '${{ matrix.url }}'

      - name: Publish report
        if: always()
        uses: mikepenz/action-junit-report@4fa23552acda20a6a1d44f16224a90efbeb6c5f1 # v3.7.5
        with:
          report_paths: '**/dastardly-report.xml'
          require_tests: true
